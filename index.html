<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title> 文生图 (智能路径版)</title>
  <meta name="theme-color" content="#1e1e2e"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --brand:#6366f1;
      --bg:#f5f5f7;
      --bg-card:hsla(0,0%,100%,.85);
      --text:#1c1c1e;
      --text-secondary:#6e6e73;
      --border:hsla(0,0%,100%,.4);
      --radius:16px;
      --shadow:0 8px 32px rgba(0,0,0,.08);
      --font:'Inter',system-ui,sans-serif;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0c0c0e;
        --bg-card:hsla(240,7%,15%,.7);
        --text:#f2f2f7;
        --text-secondary:#a1a1a6;
        --border:hsla(240,7%,22%,.6);
      }
    }
    *{box-sizing:border-box;font-family:var(--font)}
    body{margin:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:24px;color:var(--text)}
    .glass{
      width:100%;max-width:520px;padding:28px;
      border-radius:var(--radius);background:var(--bg-card);
      border:1px solid var(--border);box-shadow:var(--shadow);
      backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    }
    h1{text-align:center;font-size:20px;margin:0 0 24px;color:var(--brand)}
    label{font-size:13px;font-weight:600;margin-bottom:6px;display:block;color:var(--text-secondary)}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:8px;
      border:1px solid var(--border);background:rgba(255,255,255,0.3);
      color:var(--text);font-size:14px;transition:all .2s;
    }
    @media (prefers-color-scheme: dark){input,select,textarea{background:rgba(0,0,0,0.2)}}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);background:var(--bg-card)}
    .row{display:flex;gap:10px}
    .row>div{flex:1}
    button{
      width:100%;padding:12px;border-radius:10px;font-size:14px;font-weight:600;
      border:none;cursor:pointer;background:var(--brand);color:#fff;
      transition:opacity .2s;margin-top:12px;
    }
    button:hover{opacity:0.9}
    button:disabled{background:#a1a1aa;cursor:not-allowed}
    .btn-secondary{background:transparent;color:var(--brand);border:1px solid var(--brand);margin-top:0}
    .btn-secondary:hover{background:var(--brand);color:#fff}
    .status-box{padding:12px;border-radius:8px;font-size:13px;margin:16px 0;background:rgba(219,234,254,.5);color:#1d4ed8;text-align:center}
    .error-box{padding:12px;border-radius:8px;font-size:13px;margin:16px 0;background:rgba(254,226,226,.5);color:#b91c1c;word-break:break-all}
    .hidden{display:none}
    #result img{width:100%;border-radius:8px;margin-bottom:12px;background:#eee;min-height:200px;object-fit:contain}
    .actions{display:flex;gap:8px}
    .real-url{font-size:11px;color:var(--text-secondary);margin-top:4px;word-break:break-all;opacity:0.8}
  </style>
</head>
<body>
  <div class="glass">
    <h1>文生图 (智能路径版)</h1>

    <!-- 配置项 -->
    <div style="background:rgba(127,127,127,0.05);padding:12px;border-radius:8px;margin-bottom:16px">
      <label>API 域名 (Base URL)</label>
      <input type="text" id="apiBaseUrl" placeholder="例如 https://api.openai.com 或 https://api.example.com" />
      <div class="real-url">实际请求地址: <span id="realUrlPreview">...</span></div>
      
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>模型名称</label>
          <input type="text" id="modelName" placeholder="dall-e-3" value="dall-e-3" />
        </div>
        <div style="flex:1.5">
          <label>API Key</label>
          <input type="password" id="apiKey" placeholder="sk-..." />
        </div>
      </div>
    </div>

    <!-- 参数 -->
    <div class="row">
      <div>
        <label>尺寸</label>
        <select id="sizeSelect">
          <option value="1024x1024">1024×1024</option>
          <option value="1024x1792">1024×1792</option>
          <option value="512x512">512×512</option>
        </select>
      </div>
      <div>
        <label>质量</label>
        <select id="qualitySelect">
          <option value="standard">Standard</option>
          <option value="hd">HD</option>
        </select>
      </div>
    </div>

    <label style="margin-top:16px">提示词</label>
    <textarea id="promptInput" placeholder="描述画面..."></textarea>

    <button id="generateBtn">生成图片</button>

    <div id="statusBox" class="status-box hidden"></div>
    <div id="errorBox" class="error-box hidden"></div>

    <div id="result" class="hidden" style="margin-top:16px">
      <img id="resultImg" alt="Result"/>
      <div class="actions">
        <button class="btn-secondary" id="downloadBtn">下载</button>
        <button class="btn-secondary" id="copyPromptBtn">复制提示词</button>
      </div>
    </div>
  </div>

<script>
(()=>{
  const $ = s => document.querySelector(s);
  const CONFIG = ['apiBaseUrl', 'modelName', 'apiKey', 'sizeSelect'];
  
  // 1. 读取保存的配置
  CONFIG.forEach(k => {
    const v = localStorage.getItem('smart_cfg_' + k);
    if(v) $(`#${k}`).value = v;
    $(`#${k}`).addEventListener('input', updatePreview);
    $(`#${k}`).addEventListener('change', e => localStorage.setItem('smart_cfg_' + k, e.target.value.trim()));
  });

  // 智能处理 URL
  function getFullUrl() {
    let base = $('#apiBaseUrl').value.trim();
    if (!base) return '';
    
    // 去掉末尾斜杠
    if (base.endsWith('/')) base = base.slice(0, -1);
    
    // 如果用户填了完整的 chat 路径，强制替换
    if (base.includes('/v1/chat/completions')) {
      base = base.replace('/v1/chat/completions', '');
    }
    
    // 如果用户已经填了 /v1/images/generations，就直接用
    if (base.endsWith('/v1/images/generations')) {
      return base;
    }

    // 如果填的是 /v1，去掉它，后面统一加
    if (base.endsWith('/v1')) base = base.slice(0, -3);

    // 拼接标准路径
    return base + '/v1/images/generations';
  }

  function updatePreview() {
    const url = getFullUrl();
    $('#realUrlPreview').textContent = url || '等待输入...';
  }
  
  // 初始化预览
  updatePreview();

  // 2. 状态显示
  const setStatus = (msg, isErr = false) => {
    const sBox = $('#statusBox');
    const eBox = $('#errorBox');
    if(isErr){
      sBox.classList.add('hidden');
      eBox.textContent = msg;
      eBox.classList.remove('hidden');
    } else {
      eBox.classList.add('hidden');
      sBox.textContent = msg;
      sBox.classList.remove('hidden');
    }
  };

  // 3. 生成逻辑
  $('#generateBtn').onclick = async () => {
    const url = getFullUrl();
    const key = $('#apiKey').value.trim();
    const prompt = $('#promptInput').value.trim();
    
    if(!url || !key || !prompt) return setStatus('请填写完整的 API 信息和提示词', true);

    $('#generateBtn').disabled = true;
    $('#result').classList.add('hidden');
    setStatus(`正在请求: ${url}`);

    try {
      // 这里的 body 非常干净，只包含 OpenAI 定义的标准参数
      const body = {
        model: $('#modelName').value.trim(),
        prompt: prompt,
        size: $('#sizeSelect').value,
        quality: $('#qualitySelect').value,
        n: 1
      };

      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${key}`
        },
        body: JSON.stringify(body)
      });

      if(!res.ok) {
        const txt = await res.text();
        let msg = `HTTP ${res.status}`;
        try { msg = JSON.parse(txt).error.message || msg; } catch(e){}
        throw new Error(msg);
      }

      setStatus('请求成功，正在解析...');
      const data = await res.json();
      
      let imgSrc = '';
      const item = data.data?.[0];
      
      if (item?.url) {
        imgSrc = item.url;
      } else if (item?.b64_json) {
        imgSrc = `data:image/png;base64,${item.b64_json}`;
      } else {
        throw new Error('API 返回了未知的数据格式');
      }

      const img = $('#resultImg');
      img.onload = () => {
        setStatus('');
        $('#statusBox').classList.add('hidden');
        $('#result').classList.remove('hidden');
        $('#generateBtn').disabled = false;
      };
      img.onerror = () => {
        setStatus('图片加载失败 (可能是 URL 跨域问题)', true);
        $('#generateBtn').disabled = false;
      };
      img.src = imgSrc;

    } catch(e) {
      // 再次捕获 messages 错误进行提示
      if(e.message.includes('messages is required')) {
        setStatus('错误：服务端仍将其识别为对话请求。请检查 API 域名是否为专用的生图渠道，或联系 API 提供商确认生图端点。', true);
      } else {
        setStatus(e.message, true);
      }
      $('#generateBtn').disabled = false;
    }
  };

  $('#downloadBtn').onclick = () => {
    const src = $('#resultImg').src;
    const a = document.createElement('a');
    a.href = src;
    a.download = `image-${Date.now()}.png`;
    if(!src.startsWith('data:')) a.target = '_blank'; 
    a.click();
  };
  
  $('#copyPromptBtn').onclick = () => {
    navigator.clipboard.writeText($('#promptInput').value);
    alert('提示词已复制');
  };
})();
</script>
</body>
</html>
