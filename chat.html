<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Lite Tavern · 网页版酒馆</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg-color: #121212;
      --chat-bg: #1e1e1e;
      --sidebar-bg: #252525;
      --accent: #8b5cf6;
      --text: #e5e5e5;
      --text-dim: #a3a3a3;
      --user-msg-bg: #3f3f46;
      --char-msg-bg: #27272a;
      --border: #404040;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans SC', sans-serif; }
    body { background: var(--bg-color); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

    /* 侧边栏 (设置) */
    .sidebar {
      width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; padding: 16px; overflow-y: auto;
      transition: transform 0.3s ease; z-index: 100;
    }
    .sidebar.closed { transform: translateX(-100%); position: absolute; height: 100%; }
    
    /* 移动端适配侧边栏 */
    @media (max-width: 768px) {
      .sidebar { position: absolute; height: 100%; box-shadow: 4px 0 16px rgba(0,0,0,0.5); }
    }

    h2 { font-size: 16px; margin-bottom: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .group { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
    label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 6px; }
    input, textarea, select {
      width: 100%; background: #18181b; border: 1px solid #3f3f46; color: white;
      padding: 8px; border-radius: 6px; font-size: 13px; outline: none; margin-bottom: 8px;
    }
    input:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 80px; }

    /* 聊天主区域 */
    .main { flex: 1; display: flex; flex-direction: column; position: relative; background-image: radial-gradient(#2a2a2a 1px, transparent 1px); background-size: 20px 20px; }
    
    /* 顶部导航 */
    .header {
      height: 50px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px;
      background: rgba(30,30,30,0.9); backdrop-filter: blur(10px); justify-content: space-between;
    }
    .btn-icon { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 4px; }
    
    /* 聊天记录列表 */
    #chatList { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
    
    /* 消息气泡 */
    .msg { display: flex; gap: 12px; max-width: 800px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; }
    .msg.user { flex-direction: row-reverse; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; object-fit: cover; flex-shrink: 0; }
    .bubble {
      background: var(--char-msg-bg); padding: 12px 16px; border-radius: 12px;
      line-height: 1.6; font-size: 14px; position: relative; white-space: pre-wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .msg.user .bubble { background: var(--user-msg-bg); border-top-right-radius: 2px; }
    .msg.char .bubble { border-top-left-radius: 2px; }
    .msg-name { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
    .msg.user .msg-name { text-align: right; }

    /* 底部输入框 */
    .input-area {
      padding: 16px; background: var(--chat-bg); border-top: 1px solid var(--border);
      display: flex; gap: 10px; align-items: flex-end; max-width: 900px; margin: 0 auto; width: 100%;
    }
    #userInput {
      flex: 1; background: #27272a; border: none; padding: 12px; border-radius: 8px;
      max-height: 150px; overflow-y: auto;
    }
    #sendBtn {
      background: var(--accent); color: white; border: none; padding: 0 20px; height: 42px;
      border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s;
    }
    #sendBtn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* 遮罩层 (移动端用) */
    .overlay {
      position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5);
      z-index: 90; display: none;
    }
    .overlay.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
    
    /* 状态提示 */
    .typing-indicator { font-size: 12px; color: var(--text-dim); margin-left: 54px; margin-bottom: 10px; height: 20px; }
  </style>
</head>
<body>

  <!-- 侧边栏：设置 -->
  <div class="sidebar" id="sidebar">
    <div class="group">
      <h2>API 设置</h2>
      <label>API 地址 (Base URL)</label>
      <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1" />
      <label>API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
      <label>模型 (Model)</label>
      <input type="text" id="modelName" value="gpt-3.5-turbo" />
    </div>

    <div class="group">
      <h2>角色设定 (Character)</h2>
      <label>角色名字</label>
      <input type="text" id="charName" value="Silly" />
      <label>角色头像 URL</label>
      <input type="text" id="charAvatar" placeholder="图片链接..." />
      <label>人设 / System Prompt</label>
      <textarea id="charPersona" style="height:150px" placeholder="你叫Silly，是一个猫娘助手，说话句尾喜欢加喵..."></textarea>
    </div>

    <div class="group">
      <h2>用户设定</h2>
      <label>你的名字</label>
      <input type="text" id="userName" value="User" />
    </div>

    <div style="margin-top:auto">
      <button onclick="clearChat()" style="width:100%;padding:10px;background:#ef4444;border:none;border-radius:6px;color:white">清空聊天记录</button>
    </div>
  </div>
  
  <div class="overlay" id="overlay"></div>

  <!-- 主界面 -->
  <div class="main">
    <div class="header">
      <button class="btn-icon" id="toggleSidebar">☰</button>
      <span style="font-weight:600;font-size:14px" id="headerTitle">Lite Tavern</span>
      <div style="width:24px"></div>
    </div>

    <div id="chatList">
      <!-- 消息会在这里生成 -->
      <div class="msg char">
        <div class="avatar" style="background:var(--accent)"></div>
        <div>
          <div class="msg-name">System</div>
          <div class="bubble">欢迎来到 Lite Tavern！请点击左上角菜单配置 API 和角色设定。</div>
        </div>
      </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator"></div>

    <div class="input-area">
      <textarea id="userInput" rows="1" placeholder="发送消息..."></textarea>
      <button id="sendBtn">发送</button>
    </div>
  </div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  
  // 状态管理
  const state = {
    messages: [], // 聊天记录
    isSidebarOpen: window.innerWidth > 768
  };

  // 1. 初始化与配置加载
  const CONFIG_IDS = ['apiUrl', 'apiKey', 'modelName', 'charName', 'charAvatar', 'charPersona', 'userName'];
  
  function loadConfig() {
    CONFIG_IDS.forEach(id => {
      const val = localStorage.getItem('tavern_' + id);
      if(val) $(id).value = val;
      $(id).addEventListener('change', e => {
        localStorage.setItem('tavern_' + id, e.target.value);
        if(id === 'charName') updateHeader();
      });
    });
    
    const savedMsgs = localStorage.getItem('tavern_history');
    if(savedMsgs) {
      state.messages = JSON.parse(savedMsgs);
      renderHistory();
    }
    
    updateHeader();
    handleResize();
  }

  function updateHeader() {
    $('headerTitle').textContent = $('charName').value || 'Lite Tavern';
  }

  // 2. 界面交互
  const sidebar = $('sidebar');
  const overlay = $('overlay');
  
  $('toggleSidebar').onclick = () => {
    state.isSidebarOpen = !state.isSidebarOpen;
    updateSidebarUI();
  };
  
  overlay.onclick = () => {
    state.isSidebarOpen = false;
    updateSidebarUI();
  };

  function updateSidebarUI() {
    if(state.isSidebarOpen) {
      sidebar.classList.remove('closed');
      if(window.innerWidth <= 768) overlay.classList.add('active');
    } else {
      sidebar.classList.add('closed');
      overlay.classList.remove('active');
    }
  }
  
  function handleResize() {
    if(window.innerWidth <= 768) {
      state.isSidebarOpen = false;
    } else {
      state.isSidebarOpen = true;
    }
    updateSidebarUI();
  }
  window.addEventListener('resize', handleResize);

  // 3. 聊天渲染
  function renderHistory() {
    const list = $('chatList');
    list.innerHTML = '';
    state.messages.forEach(msg => appendMsgToDOM(msg));
    scrollToBottom();
  }

  function appendMsgToDOM(msg) {
    const isUser = msg.role === 'user';
    const name = isUser ? $('userName').value : $('charName').value;
    const avatarUrl = isUser ? '' : $('charAvatar').value; // 用户暂无头像设置，用默认
    
    const div = document.createElement('div');
    div.className = `msg ${isUser ? 'user' : 'char'}`;
    
    let avatarHtml = `<div class="avatar" style="background:${isUser?'#3f3f46': 'var(--accent)'}"></div>`;
    if(!isUser && avatarUrl) {
      avatarHtml = `<img class="avatar" src="${avatarUrl}" onerror="this.style.display='none'">`;
    }

    div.innerHTML = `
      ${avatarHtml}
      <div style="max-width:80%">
        <div class="msg-name">${name}</div>
        <div class="bubble">${escapeHtml(msg.content)}</div>
      </div>
    `;
    $('chatList').appendChild(div);
  }

  function scrollToBottom() {
    const list = $('chatList');
    list.scrollTop = list.scrollHeight;
  }
  
  function escapeHtml(text) {
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
  }

  // 4. 发送逻辑
  $('sendBtn').onclick = sendMessage;
  
  // 简单的 Textarea 自适应高度
  $('userInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  async function sendMessage() {
    const input = $('userInput');
    const text = input.value.trim();
    if(!text) return;

    const apiKey = $('apiKey').value.trim();
    let apiUrl = $('apiUrl').value.trim();
    
    if(!apiKey) { alert('请先在侧边栏填写 API Key'); return; }
    if(!apiUrl) { alert('请先填写 API 地址'); return; }

    // URL 修正
    if(apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
    if(!apiUrl.includes('/chat/completions')) apiUrl += '/chat/completions';

    // 1. 添加用户消息
    const userMsg = { role: 'user', content: text };
    state.messages.push(userMsg);
    appendMsgToDOM(userMsg);
    saveHistory();
    
    input.value = '';
    input.style.height = 'auto';
    scrollToBottom();
    
    // 2. 准备请求上下文
    const systemPrompt = $('charPersona').value.trim();
    const context = [];
    if(systemPrompt) context.push({ role: 'system', content: systemPrompt });
    
    // 简单的上下文截断（防止超长），取最后 20 条
    const historyToSend = state.messages.slice(-20); 
    context.push(...historyToSend);

    // 3. 发送请求
    $('sendBtn').disabled = true;
    $('typingIndicator').textContent = $('charName').value + ' 正在输入...';

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: $('modelName').value.trim(),
          messages: context,
          temperature: 0.8,
          max_tokens: 500 // 防止回复太长
        })
      });

      if(!res.ok) {
        const errTxt = await res.text();
        throw new Error(`Error ${res.status}: ${errTxt}`);
      }

      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || '(无回复)';
      
      const charMsg = { role: 'assistant', content: reply };
      state.messages.push(charMsg);
      appendMsgToDOM(charMsg);
      saveHistory();

    } catch(e) {
      alert('请求失败: ' + e.message);
      // 如果失败，把刚才用户的消息也删掉，或者提示重试（这里简单处理不删，方便复制）
    } finally {
      $('sendBtn').disabled = false;
      $('typingIndicator').textContent = '';
      scrollToBottom();
    }
  }

  function saveHistory() {
    localStorage.setItem('tavern_history', JSON.stringify(state.messages));
  }
  
  window.clearChat = () => {
    if(confirm('确定要清空所有聊天记录吗？')) {
      state.messages = [];
      saveHistory();
      renderHistory();
    }
  };

  // 启动
  loadConfig();
})();
</script>
</body>
</html>
