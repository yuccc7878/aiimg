<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Lite Tavern Â· ä¿®å¤ç‰ˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg-color: #121212;
      --chat-bg: #1e1e1e;
      --sidebar-bg: #252525;
      --accent: #8b5cf6;
      --text: #e5e5e5;
      --text-dim: #a3a3a3;
      --user-msg-bg: #3f3f46;
      --char-msg-bg: #27272a;
      --border: #404040;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg-color); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

    /* ä¾§è¾¹æ  (è®¾ç½®) */
    .sidebar {
      width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; padding: 16px; overflow-y: auto;
      transition: transform 0.3s ease; z-index: 100;
      position: absolute; height: 100%; top: 0; left: 0;
    }
    /* é»˜è®¤å…³é—­çŠ¶æ€ (ç§»åŠ¨ç«¯ä¼˜å…ˆ) */
    .sidebar.closed { transform: translateX(-100%); }
    /* æ¡Œé¢ç«¯é»˜è®¤è¡Œä¸ºåœ¨ JS é‡Œæ§åˆ¶ï¼Œæˆ–è€…ç”¨åª’ä½“æŸ¥è¯¢è¦†ç›– */
    @media (min-width: 769px) {
      .sidebar { position: relative; transform: none; }
      .sidebar.closed { transform: translateX(-100%); position: absolute; }
    }

    h2 { font-size: 16px; margin-bottom: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .group { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
    label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 6px; }
    
    input, textarea, select {
      width: 100%; background: #18181b; border: 1px solid #3f3f46; color: white;
      padding: 10px; border-radius: 6px; font-size: 14px; outline: none; margin-bottom: 8px;
    }
    input:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 80px; }

    /* ç‰¹æ®Šè¾“å…¥æ¡†å®¹å™¨ï¼šç”¨äº API Key */
    .input-wrapper { position: relative; display: flex; align-items: center; }
    .input-wrapper input { padding-right: 40px; margin-bottom: 0; }
    .toggle-eye {
      position: absolute; right: 0; top: 0; bottom: 0; width: 40px;
      background: none; border: none; color: var(--text-dim); cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 18px;
    }
    /* CSS é®ç½©ç±»ï¼šä¸æ”¹å˜ input type="text"ï¼Œåªæ”¹å˜è§†è§‰æ˜¾ç¤º */
    .masked-text { -webkit-text-security: disc; }

    /* èŠå¤©ä¸»åŒºåŸŸ */
    .main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }
    
    /* é¡¶éƒ¨å¯¼èˆª */
    .header {
      height: 50px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px;
      background: rgba(30,30,30,0.95); justify-content: space-between; flex-shrink: 0;
    }
    .btn-icon { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 8px; }
    
    /* èŠå¤©è®°å½•åˆ—è¡¨ */
    #chatList { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
    
    /* æ¶ˆæ¯æ°”æ³¡ */
    .msg { display: flex; gap: 12px; max-width: 800px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; }
    .msg.user { flex-direction: row-reverse; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; object-fit: cover; flex-shrink: 0; }
    .bubble {
      background: var(--char-msg-bg); padding: 12px 16px; border-radius: 12px;
      line-height: 1.6; font-size: 15px; position: relative; white-space: pre-wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); word-break: break-word;
    }
    .msg.user .bubble { background: var(--user-msg-bg); border-top-right-radius: 2px; }
    .msg.char .bubble { border-top-left-radius: 2px; }
    .msg-name { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
    .msg.user .msg-name { text-align: right; }

    /* åº•éƒ¨è¾“å…¥æ¡† */
    .input-area {
      padding: 12px; background: var(--chat-bg); border-top: 1px solid var(--border);
      display: flex; gap: 10px; align-items: flex-end; max-width: 900px; margin: 0 auto; width: 100%;
      flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    }
    #userInput {
      flex: 1; background: #27272a; border: none; padding: 12px; border-radius: 8px;
      max-height: 120px; overflow-y: auto; font-size: 16px; /* é˜²æ­¢ iOS ç¼©æ”¾ */
    }
    #sendBtn {
      background: var(--accent); color: white; border: none; padding: 0 16px; height: 44px;
      border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; white-space: nowrap;
    }
    #sendBtn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* é®ç½©å±‚ (ç§»åŠ¨ç«¯ç”¨) */
    .overlay {
      position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5);
      z-index: 90; display: none;
    }
    .overlay.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
    
    .typing-indicator { font-size: 12px; color: var(--text-dim); margin-left: 54px; margin-bottom: 10px; height: 20px; }
  </style>
</head>
<body>

  <!-- ä¾§è¾¹æ ï¼šè®¾ç½® -->
  <div class="sidebar closed" id="sidebar">
    <div class="group">
      <h2>API è®¾ç½®</h2>
      <label>API åœ°å€ (Base URL)</label>
      <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1" />
      
      <label>API Key (æ˜æ–‡/é®ç½©)</label>
      <div class="input-wrapper">
        <!-- æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ type="text" é¿å…åŠ å¯†é”®ç›˜ï¼Œé…åˆ CSS é®ç½© -->
        <input type="text" id="apiKey" class="masked-text" placeholder="sk-..." />
        <button class="toggle-eye" id="toggleKeyVis" type="button">ğŸ‘ï¸</button>
      </div>
      
      <label style="margin-top:8px">æ¨¡å‹ (Model)</label>
      <input type="text" id="modelName" value="gpt-3.5-turbo" />
    </div>

    <div class="group">
      <h2>è§’è‰²è®¾å®š (Character)</h2>
      <label>è§’è‰²åå­—</label>
      <input type="text" id="charName" value="Silly" />
      <label>è§’è‰²å¤´åƒ URL</label>
      <input type="text" id="charAvatar" placeholder="å›¾ç‰‡é“¾æ¥..." />
      <label>äººè®¾ / System Prompt</label>
      <textarea id="charPersona" style="height:150px" placeholder="ä½ å«Sillyï¼Œæ˜¯ä¸€ä¸ªçŒ«å¨˜åŠ©æ‰‹ï¼Œè¯´è¯å¥å°¾å–œæ¬¢åŠ å–µ..."></textarea>
    </div>

    <div class="group">
      <h2>ç”¨æˆ·è®¾å®š</h2>
      <label>ä½ çš„åå­—</label>
      <input type="text" id="userName" value="User" />
    </div>

    <div style="margin-top:auto">
      <button onclick="clearChat()" style="width:100%;padding:12px;background:#ef4444;border:none;border-radius:6px;color:white;font-weight:bold">æ¸…ç©ºèŠå¤©è®°å½•</button>
    </div>
  </div>
  
  <div class="overlay" id="overlay"></div>

  <!-- ä¸»ç•Œé¢ -->
  <div class="main">
    <div class="header">
      <button class="btn-icon" id="toggleSidebar">â˜°</button>
      <span style="font-weight:600;font-size:15px" id="headerTitle">Lite Tavern</span>
      <div style="width:24px"></div>
    </div>

    <div id="chatList">
      <div class="msg char">
        <div class="avatar" style="background:var(--accent)"></div>
        <div>
          <div class="msg-name">System</div>
          <div class="bubble">æ¬¢è¿ï¼ç‚¹å‡»å·¦ä¸Šè§’ â˜° è®¾ç½® APIã€‚</div>
        </div>
      </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator"></div>

    <div class="input-area">
      <textarea id="userInput" rows="1" placeholder="å‘é€æ¶ˆæ¯..."></textarea>
      <button id="sendBtn">å‘é€</button>
    </div>
  </div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  
  // çŠ¶æ€ç®¡ç†
  const state = {
    messages: [],
    isSidebarOpen: false // é»˜è®¤å…³é—­ï¼Œé˜²æ­¢æ‰‹æœºç«¯åŠ è½½æ—¶é—ªçƒ
  };

  // 0. ä¿®å¤ API Key æ˜¾ç¤ºé€»è¾‘
  const apiKeyInput = $('apiKey');
  const toggleEye = $('toggleKeyVis');
  toggleEye.onclick = () => {
    // åˆ‡æ¢ CSS ç±»æ¥å®ç°é®ç½©/æ˜æ–‡ï¼Œä¸æ”¹å˜ input typeï¼Œä»è€Œä¸å”¤èµ·å®‰å…¨é”®ç›˜
    apiKeyInput.classList.toggle('masked-text');
    toggleEye.textContent = apiKeyInput.classList.contains('masked-text') ? 'ğŸ‘ï¸' : 'ğŸ”“';
  };

  // 1. åˆå§‹åŒ–ä¸é…ç½®åŠ è½½
  const CONFIG_IDS = ['apiUrl', 'apiKey', 'modelName', 'charName', 'charAvatar', 'charPersona', 'userName'];
  
  function loadConfig() {
    CONFIG_IDS.forEach(id => {
      const val = localStorage.getItem('tavern_' + id);
      if(val) $(id).value = val;
      $(id).addEventListener('change', e => {
        localStorage.setItem('tavern_' + id, e.target.value);
        if(id === 'charName') updateHeader();
      });
    });
    
    const savedMsgs = localStorage.getItem('tavern_history');
    if(savedMsgs) {
      state.messages = JSON.parse(savedMsgs);
      renderHistory();
    }
    
    updateHeader();
    
    // æ¡Œé¢ç«¯é»˜è®¤æ‰“å¼€ä¾§è¾¹æ 
    if(window.innerWidth > 768) {
      state.isSidebarOpen = true;
      updateSidebarUI();
    }
  }

  function updateHeader() {
    $('headerTitle').textContent = $('charName').value || 'Lite Tavern';
  }

  // 2. ç•Œé¢äº¤äº’ (æ ¸å¿ƒä¿®å¤ï¼šç§»é™¤ resize ç›‘å¬ä¸­çš„è‡ªåŠ¨å…³é—­é€»è¾‘)
  const sidebar = $('sidebar');
  const overlay = $('overlay');
  
  $('toggleSidebar').onclick = () => {
    state.isSidebarOpen = !state.isSidebarOpen;
    updateSidebarUI();
  };
  
  overlay.onclick = () => {
    state.isSidebarOpen = false;
    updateSidebarUI();
  };

  function updateSidebarUI() {
    if(state.isSidebarOpen) {
      sidebar.classList.remove('closed');
      // åªæœ‰åœ¨å°å±å¹•æ—¶æ‰æ˜¾ç¤ºé®ç½©
      if(window.innerWidth <= 768) overlay.classList.add('active');
    } else {
      sidebar.classList.add('closed');
      overlay.classList.remove('active');
    }
  }
  
  // ä»…åœ¨çª—å£å®½åº¦å‘ç”Ÿå‰§çƒˆå˜åŒ–ï¼ˆæ¨ªç«–å±åˆ‡æ¢ï¼‰æ—¶æ‰è°ƒæ•´ä¾§è¾¹æ ï¼Œé”®ç›˜å¼¹å‡ºå¯¼è‡´çš„å¾®å°å˜åŒ–å¿½ç•¥
  let lastWidth = window.innerWidth;
  window.addEventListener('resize', () => {
    if (window.innerWidth !== lastWidth) {
      lastWidth = window.innerWidth;
      if(window.innerWidth > 768) {
        state.isSidebarOpen = true; // å¤§å±è‡ªåŠ¨å¼€
      } else {
        state.isSidebarOpen = false; // å°å±è‡ªåŠ¨å…³
      }
      updateSidebarUI();
    }
  });

  // 3. èŠå¤©æ¸²æŸ“
  function renderHistory() {
    const list = $('chatList');
    list.innerHTML = '';
    state.messages.forEach(msg => appendMsgToDOM(msg));
    scrollToBottom();
  }

  function appendMsgToDOM(msg) {
    const isUser = msg.role === 'user';
    const name = isUser ? $('userName').value : $('charName').value;
    const avatarUrl = isUser ? '' : $('charAvatar').value; 
    
    const div = document.createElement('div');
    div.className = `msg ${isUser ? 'user' : 'char'}`;
    
    let avatarHtml = `<div class="avatar" style="background:${isUser?'#3f3f46': 'var(--accent)'}"></div>`;
    if(!isUser && avatarUrl) {
      avatarHtml = `<img class="avatar" src="${avatarUrl}" onerror="this.style.display='none'">`;
    }

    div.innerHTML = `
      ${avatarHtml}
      <div style="max-width:85%">
        <div class="msg-name">${name}</div>
        <div class="bubble">${escapeHtml(msg.content)}</div>
      </div>
    `;
    $('chatList').appendChild(div);
  }

  function scrollToBottom() {
    const list = $('chatList');
    setTimeout(() => list.scrollTop = list.scrollHeight, 50);
  }
  
  function escapeHtml(text) {
    if(!text) return '';
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
  }

  // 4. å‘é€é€»è¾‘
  $('sendBtn').onclick = sendMessage;
  
  // ä¼˜åŒ– Textarea ä½“éªŒ
  const userInput = $('userInput');
  userInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });
  // ç›‘å¬å›è½¦å‘é€ï¼ˆæ‰‹æœºä¸Šé€šå¸¸æ˜¯æ¢è¡Œï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ä¸åš Enter å‘é€ï¼Œåªç”¨æŒ‰é’®ï¼‰

  async function sendMessage() {
    const text = userInput.value.trim();
    if(!text) return;

    const apiKey = $('apiKey').value.trim();
    let apiUrl = $('apiUrl').value.trim();
    
    if(!apiKey) { alert('è¯·å…ˆåœ¨ä¾§è¾¹æ å¡«å†™ API Key'); $('toggleSidebar').click(); return; }
    if(!apiUrl) { alert('è¯·å…ˆå¡«å†™ API åœ°å€'); $('toggleSidebar').click(); return; }

    // URL ä¿®æ­£
    if(apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
    if(!apiUrl.includes('/chat/completions')) {
        // å¦‚æœç”¨æˆ·åªå¡«äº†åŸŸåï¼Œè‡ªåŠ¨è¡¥å…¨
        if(!apiUrl.includes('/v1')) apiUrl += '/v1';
        apiUrl += '/chat/completions';
    }

    const userMsg = { role: 'user', content: text };
    state.messages.push(userMsg);
    appendMsgToDOM(userMsg);
    saveHistory();
    
    userInput.value = '';
    userInput.style.height = 'auto';
    scrollToBottom();
    
    const systemPrompt = $('charPersona').value.trim();
    const context = [];
    if(systemPrompt) context.push({ role: 'system', content: systemPrompt });
    
    const historyToSend = state.messages.slice(-20); 
    context.push(...historyToSend);

    $('sendBtn').disabled = true;
    $('typingIndicator').textContent = $('charName').value + ' æ­£åœ¨è¾“å…¥...';

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: $('modelName').value.trim(),
          messages: context,
          temperature: 0.8,
          max_tokens: 1000 // å¢åŠ  token é™åˆ¶
        })
      });

      if(!res.ok) {
        const errTxt = await res.text();
        throw new Error(`HTTP ${res.status}: ${errTxt}`);
      }

      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || '(æ— å›å¤)';
      
      const charMsg = { role: 'assistant', content: reply };
      state.messages.push(charMsg);
      appendMsgToDOM(charMsg);
      saveHistory();

    } catch(e) {
      const errDiv = document.createElement('div');
      errDiv.style.color = '#ef4444';
      errDiv.style.textAlign = 'center';
      errDiv.style.fontSize = '12px';
      errDiv.style.margin = '10px 0';
      errDiv.textContent = 'å‘é€å¤±è´¥: ' + e.message;
      $('chatList').appendChild(errDiv);
    } finally {
      $('sendBtn').disabled = false;
      $('typingIndicator').textContent = '';
      scrollToBottom();
    }
  }

  function saveHistory() {
    localStorage.setItem('tavern_history', JSON.stringify(state.messages));
  }
  
  window.clearChat = () => {
    if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
      state.messages = [];
      saveHistory();
      renderHistory();
      if(window.innerWidth <= 768) {
          state.isSidebarOpen = false;
          updateSidebarUI();
      }
    }
  };

  loadConfig();
})();
</script>
</body>
</html>
